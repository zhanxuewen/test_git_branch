<?php

namespace App\Console\Commands\ZXZJ\Word;

use App\Foundation\Excel;
use App\Foundation\PdoBuilder;
use Carbon\Carbon;
use Illuminate\Console\Command;

class StudentHomeWorkInfo extends Command
{

    use Excel;

    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'export:student:homework';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = '导出学生的作业情况';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }


    /**
     * Execute the console command.
     *
     * @return void
     */
    public function handle()
    {
        config(['database.default' => 'online']);

        $student_order = \DB::table('order')
            ->whereIn('pay_status', ['success', 'single_success', 'group_success'])
            ->where('school_id', 932)
            ->get();

        $export_data = [];
        $export_data[] = [
            'student_id' => '学生id',
            'commodity_name' => '学习卡',
            'fee' => '购买金额',
            'channel' => '购买渠道',
        ];

        foreach ($student_order as $order_item){
            $out_trade_no = $order_item->out_trade_no;
            $trade_type = $order_item->trade_type;

            $channel = $this->getChannelByTradeNo($out_trade_no, $trade_type);

            $export_data[] = [
                'student_id' => $order_item->student_id,
                'commodity_name' => $order_item->commodity_name,
                'fee' => $order_item->pay_fee,
                'channel' => $channel,
            ];


        }

        // 保存到文件
        $this->store('学校学生订单_'.rand(0,100), $export_data, '.xlsx');

        dd('done');

        // 计算单词本的 练习时间
        $student_ids = [
            528144,528148,528149,528153,526949,528160,528159,528162,528171,528193,528195,528100,528217,528240,528255,527039,528472,528562,528026,601607,196215,505943,604126,604129,604128,604133,604132,604131,554670,604134,604135,604137,604140,508270,511986,604136,604142,604143,604144,604145,604146,604148,604150,531011,604154,604153,604169,604161,605211,504849,504852,504853,504863,504879,504888,504903,504925,504940,504960,504859,504913,505585,516882,505140,532137,575595,575834,531988,532457,504856,504922,504930,504971,504981,507574,506038,508039,510254,599468,507640,506855,507674,506718,507733,506807,507929,508017,507577,512220,508118,512728,540865,540861,507849,558966,504736,504825,504479,504565,504489,504505,504471,504494,504562,504453,504455,505736,504487,505863,508042,509657,557529,571313,505668,505361,505691,505859,508025,508027,506403,508080,508134,508135,509729,509732,514642,582390,505646,505205,505212,505217,505204,505207,505464,505208,506292,505523,513509,516725,520719,524112,528265,545859,548271,557751,574705,588599,594261,505572,505203,507934,505355,505201,505501,505206,523185,523649,523774,523957,505390,505227,523106,545427,599031,605824,505656,504364,505846,576422,576722,506518,577052,505607,579960,605126,595446,595431,595379,595456,595809,595860,595861,595385,595796,595807,595521,595393,594342,595833,595969,595435,595437,596185,595829,595798,596193,504656,504657,504658,504663,504664,504669,504676,504659,504709,504711,504726,504735,504764,505565,536335,578875,516859,516868,516903,516923,516962,516855,518625,518938,518999,519297,524033,531592,599390,599394,599396,599398,599408,599409,599413,599417,599416,599420,599425,599430,599455,599466,599540,599558,599559,601535,599728,599739,599831,600322,601745,602872,603255,602889,607095,607097,607116,504851,504854,504858,504871,504872,504876,504900,504941,504982,504995,504977,505165,505174,505853,506019,506393,516711,598844,505569,505873,505945,507319,511825,516908,518584,505947,544108,544441,544413,504910,504923,504917,504924,505014,505029,505106,505107,504502,504857,505024,505180,516895,517018,519171,534285,550477,550479,550486,550610,550611,550618,550630,550636,550644,550905,551226,551329,552386,596774,596817,596893,596898,596956,596987,597218,597219,598342,596823,506735,506740,506746,506747,506756,506786,507174,507195,507290,507330,507415,507418,507686,507457,507465,516236,577382,595694,504314,507572,507565,507546,507744,507544,507654,507786,507788,507790,507805,507818,507801,508084,509724,513280,515082,507794,518686,578422,519622,519823,519521,519639,519850,519460,519722,519851,519854,519969,520066,519563,520142,519654,530671,559232,510804,510862,510875,510796,511334,511511,511561,511747,511799,511759,512821,513315,513953,516294,516537,523013,511515,510820,601493,511642,512213,512869,516687,516688,516703,516720,516724,516727,516757,512605,515717,515722,515726,515728,515811,516009,516023,516048,516436,516438,516441,518301,516017,522824,600241,546117,546121,546126,546131,546147,546150,546162,546334,546366,546328,546154,546118,546120,546125,546141,546243,546123,547657,506700,506879,506688,506949,507065,506946,507002,507231,516341,506701,508066,525330,528199,544017,516462,516503,516502,516458,516459,516499,516455,516505,516507,516512,516513,516521,516545,516574,516647,516657,516684,516607,516743,517068,516460,516461,516457,516467,516473,516478,516454,516485,516504,516514,516484,516523,516453,516549,516558,516557,516559,516567,516730,595741,595764,504372,519570,519569,519568,519566,519572,519573,519579,519582,519597,519594,519605,519610,519621,519620,519641,519918,521577,522451,578609,594926,507487,507488,507493,507505,507504,507506,507945,512290,519964,544495,544496,518391,518464,518467,518468,518251,518465,518470,518462,518469,518463,518486,519009,519183,521567,522458,523613,527015,527199,544314,570958,591233,518855,519863,519956,519974,520099,522534,544241,519289,519287,519294,519293,519295,519290,519298,519302,519323,519327,519329,519334,519291,519410,519749,519926,519990,519296,523679,527849,608349,519877,519875,519872,519876,519871,519874,519878,519873,519880,519879,519882,519888,519890,519884,521558,521921,566873,580733,560020,507510,507567,507908,507931,507926,507941,507930,508167,508262,508632,509569,516378,509985,516410,516546,516555,519032,222994,576210,508006,522966,522968,522965,522970,522967,522971,522973,522975,523326,524572,524574,524576,524578,523545,523439,528949,555136,580921,597636,523088,523089,523092,523091,523087,523096,523099,523097,523090,523109,523312,523107,523101,523497,523521,524275,524632,524655,531424,523894,544902,544901,544903,544904,544907,544910,544908,544905,544909,544911,544912,544914,544917,544984,545021,545097,545118,544923,544936,563875,565406,565411,566468,566725,566947,576811,577720,596612,597348,562297,562318,562339,562351,562352,562358,562359,562361,562402,562572,562618,562155,562740,562764,564368,565769,576790,512796,512797,512798,512799,512800,512842,512951,512976,513881,513893,513938,513946,515196,510754,511141,510755,510769,511337,512455,590975,599741,578632,578767,507208,507236,507302,507240,507279,507300,507305,507306,507309,507317,507344,507241,507428,512173,518406,518649,516001,516008,507304,552967,507381,504660,508308,508307,508316,508336,508347,508355,508410,508597,508737,509745,509972,510283,511347,512558,513737,513763,515427,523127,530737,530741,508664,542024,542026,542027,542028,542031,542032,542057,542078,542082,542093,542068,542225,543442,543806,544092,544461,581717,579434,579431,579444,579457,579515,579516,579669,579754,579830,580099,580449,586808,590667,590789,592894,516533,602720,507237,506952,507552,507181,507771,506772,506777,507817,507724,506775,507829,506768,506778,512815,514431,516388,508234,539994,541456,506781,506780,507912,506773,507916,507796,506794,512672,512895,513174,506798,506779,506991,506894,506784,507000,506876,507389,507037,506774,513660,514413,518636,518646,562088,565040,565378,565414,565484,565549,565038,565039,565596,568401,569520,592859,595122,575363,575367,575368,575366,575386,510770,510765,510780,510782,510786,510797,510810,510992,511026,516524,516534,516569,516619,516526,516525,516528,516636,516646,516700,516660,516736,516710,576271,608511,608566,608565,608569,608567,608571,608568,608611,608757,608916,522741,522745,522744,522751,522752,522754,522756,522830,522836,523142,522742,523861,523878,523898,523907,524165,524280,524518,581350,602119,602121,602120,602122,602123,602127,602146,602145,602223,602158,602226,602243,602272,602308,602322,602360,602128,602700,519364,519662,519661,519663,519667,519664,519666,519669,519668,519671,519670,519673,519678,519799,519886,519683,521001,520080,519284,519266,519267,519263,519275,519274,519282,519276,519288,519348,519358,519372,519374,519413,520614,529246,520024,536779,562364,600672,556663,556661,556662,556658,556665,556660,556664,556666,556668,556719,556738,557227,562567,591368,591385,592203,592208,599724,602605,577326,523646,523647,523653,523650,523651,523655,523648,523659,523718,523726,523829,523873,523914,523652,524656,524677,524684,524704,581986,586513,523887,523888,523889,523890,523892,523895,523899,524674,526653,526976,537152,557481,559471,562462,562581,574517,574532,582224,526604,526406,526400,526403,526573,526396,526927,526565,526590,526939,526943,527285,528396,528073,530310,531644,549246,556820,559790,601994,531771,531769,531767,531789,531801,531825,531837,531842,531852,531999,532098,532222,532272,527181,526528,532434,531768,550345,550552,551599,552680,552894,552946,553009,553010,556274,556684,556996,557814,556709,565408,565034,567430,565035,566054,512872,512874,512875,512876,512879,512882,512878,512883,512884,512953,513900,515011,516356,524054,511099,596809,520011,520033,520039,520048,520049,520058,520148,520184,520227,520267,520281,520283,520295,520373,520518,520985,555932,555933,555934,555962,555968,555990,556583,556871,556901,557773,557833,558286,558739,559843,559271,567806,570978,572091,577131,594595,570965,570967,537648,570968,570984,570983,570985,570991,571010,571036,571136,571146,571534,579916,582251,591469,594454,595567,510839,510885,512005,512015,512515,512537,516768,516975,516651,513679,513058,511593,540403,544520,510742,508016,513088,512454,510616,510591,508264,507993,583758,583765,583807,583979,584066,584090,584438,584743,585353,585358,586785,507009,506874,506792,507385,599757,506770,506734,506741,506744,506737,506755,506726,506758,506760,506727,506963,506967,507064,507249,507276,507291,507301,507443,507110,507769,506731,506730,506732,506736,506748,506728,507005,507203,507220,507384,508339,511220,583164,595805,598929,506284,506293,506340,506350,506366,506542,507404,507784,507517,507800,514006,507819,529347,543549,504370,592378,507832,507837,507845,507847,507867,507953,507989,511254,518567,576680,581059,581145,581348,581414,583560
        ];
        $student_word_info = \DB::table('statistic_student_data')
            ->selectRaw('student_id, count(word_spend_time > 0 OR NULL) word_count, count(*) total_days')
            ->whereIn('student_id', $student_ids)
            ->where('created_date', '<=','2019-07-31')
            ->groupBy('student_id')
            ->get();


        $student_word_record = [];
        foreach ($student_word_info as $item){
            $student_word_record[$item->student_id] = $item->word_count;
        }

        $student_learn_record = [];
        foreach ($student_word_info as $item){
            $student_learn_record[$item->student_id] = $item->total_days;
        }

        $vanclass_ids = [
            34623,37940,43052,31504,31505,31430,31434,31433,31560,34012,40277,41954,31425,31443,42500,42530,31436,31514,31515,37186,42224,30634,31765,33359,37734,32242,32326,32392,32797,36659,31431,32882,32883,38248,31435,31901,31906,31908,33544,33552,38233,32796,31919,34026,34027,36436,37170,38201,31439,31764,31423,35945,40770,31426,31427,31428,38854,40365,32239,32789,43509,33912,32606,42567,33110,33111,37545,40723,34014,34015,34139,34985,37120,31441,32841,37622,43058,38341,38343,38701,38928,31752,31993,41124,31341,31791,31432,31792
        ];

        $export_data = [];
        $export_data[] = [
            'teacher'       => '老师',
            'vanclass_id' => '班级id',
            'vanclass_name' => '班级名称',
            'student_id'    => '学生id',
            'mark_name'     => '学生备注名',
            'total_count'   => '学生作业',
            'funished'      => '已完成作业',
            'learn_counts'  => '学习总天数',
            'word_counts'   => '单词本练习天数',
        ];
        $this->output->progressStart(count($vanclass_ids));
        foreach ($vanclass_ids as $vanclass_id){
//            $vanclass_id = 43052;
            // 查看班级 老师 信息
            $vanclass_info = \DB::table('vanclass_teacher')
                ->selectRaw('vanclass.name vanclass_name,  user_account.nickname teacher')
                ->leftJoin('user_account','user_account.id','=','vanclass_teacher.teacher_id')
                ->leftJoin('vanclass','vanclass.id','=','vanclass_teacher.vanclass_id')
                ->where('vanclass_id', $vanclass_id)
                ->first();

            $vanclass_homework_record = \DB::table('vanclass_student_homework')
                ->selectRaw('vanclass_student_homework.student_id, 
                count(*) total_count,sum(is_finish) funished, vanclass_student.mark_name')
                ->leftJoin('vanclass_student','vanclass_student_homework.student_id','=','vanclass_student.student_id')
                ->where('vanclass_student_homework.vanclass_id', $vanclass_id)
                ->where('vanclass_student_homework.created_at', '<=', '2019-08-01 00:00:00')
                ->where('vanclass_student.vanclass_id', $vanclass_id)
                ->whereNull('deleted_at')
                ->groupBy('vanclass_student_homework.student_id')
                ->get();



            foreach ($vanclass_homework_record as $vanclass_homework_record_item){
                $student_id = $vanclass_homework_record_item->student_id;
                $word_counts = (isset($student_word_record[$student_id]) ? ($student_word_record[$student_id] ?$student_word_record[$student_id]: '0' ) : '0');
                $learn_counts = (isset($student_learn_record[$student_id]) ? ($student_learn_record[$student_id] ?$student_learn_record[$student_id] : '0') : '0');
                $export_data[] = [
                    'teacher'       => $vanclass_info->teacher,
                    'vanclass_id'   => $vanclass_id,
                    'vanclass_name' => $vanclass_info->vanclass_name,
                    'student_id'    => $student_id,
                    'mark_name'     => $vanclass_homework_record_item->mark_name,
                    'total_count'   => $vanclass_homework_record_item->total_count,
                    'funished'      => $vanclass_homework_record_item->funished,
                    'learn_counts'  => $learn_counts,
                    'word_counts'   => $word_counts,
                ];
            }

//            dd($export_data);
            $this->output->progressAdvance();
        }
        $this->output->progressFinish();



        // 保存到文件
        $this->store('学生学习情况_'.rand(0,100), $export_data, '.xlsx');

        dd('done');
    }



    private function getChannelByTradeNo($out_trade_no,$trade_type){
        $channel_arr = explode('_', $out_trade_no);
        $channel = '';
        switch ($channel_arr[1]){
            case 2: //家长端
                $channel = $trade_type == 'JSAPI' ? '家长端-直接购买-微信' : '家长端-家长代付-微信';
                break;
            case 5: // 学生端
                switch ($channel_arr[3]){
                    case 1: //微信
                        $channel = $trade_type == 'wechat_app' ? '安卓-直接购买-微信' : '安卓-家长代付-微信';
                        break;
                    case 2: // 支付宝
                        $channel = $trade_type == 'alipay_app' ? '安卓-直接购买-支付宝' : '安卓-家长代付-支付宝';
                        break;
                    case 3: // IOS
                        $channel = 'IOS-苹果支付';
                        break;
                    case 4: // IOS
                        $channel = '感恩节活动';
                        break;
                }
                break;
            case 6: // 优惠页
                $channel = '优惠页-微信';
                break;
        }

        return $channel;
    }
}
